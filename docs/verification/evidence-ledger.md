# Evidence Ledger

Project-level evidence summaries and provenance tracking.

## Totals

- Approved function renames: `5`
- Approved data labels: `0`
- Review queue entries: `0`
- Protocol message rows: `131`

## Protocol Confidence

- `high`: `131`
- `medium`: `0`
- `low`: `0`

## Latest Evidence Sources

- `evidence/reverse/search_download_symbols_nm.txt`
- `evidence/reverse/disasm/server_send_message.txt`
- `evidence/reverse/disasm/server_file_search.txt`
- `evidence/reverse/server_messagecodetostring_otool.txt`
- `evidence/reverse/message_name_strings.txt`
- `evidence/reverse/disasm/peer_queue_download.txt`
- `evidence/reverse/disasm/transfer_on_file_request.txt`
- `captures/redacted/login-private-room-membership-control/official_frames.hex`
- `captures/redacted/login-static-server-runtime/official_frames.hex`
- `captures/redacted/login-legacy-distributed-control/official_frames.hex`
- `captures/redacted/login-legacy-residual-control/official_frames.hex`
- `captures/redacted/login-legacy-room-operatorship-control/official_frames.hex`
- `captures/redacted/login-global-room-control/official_frames.hex`
- `captures/redacted/login-peer-message/official_frames.hex`
- `captures/redacted/peer-static-runtime/official_frames.hex`
- `analysis/re/flow_graph.json`
- `analysis/re/format_candidates.json`
- `analysis/re/official_file_format_map.json`
- `docs/re/static/file-format-map.md`
- `evidence/ui_audit/decomp/runtime_hook_offsets_arm64.txt`
- `evidence/reverse/search_download_symbols_nm.txt`
- `evidence/reverse/search_download_strings.txt`
- `frida/hooks/soulseek_io_trace.js`
- `tools/runtime/official_runner.py`
- `captures/raw/20260216T235428Z-s9p-v3-t05-runner-both-debug-r2/manifest.raw.json`
- `captures/raw/20260216T235612Z-s9p-v3-t05-runner-both-debug-r3/manifest.raw.json`
- `captures/raw/20260217T000258Z-s9p-v3-t04f-startup-io-r4/manifest.raw.json`
- `captures/raw/20260217T010817Z-i3-t04-io-runtime-r5/manifest.raw.json`
- `captures/raw/20260217T010817Z-i3-t04-io-runtime-r5/io-events.raw.jsonl`
- `captures/raw/20260217T024407Z-i4-t04-io-qt-symbol-r2/manifest.raw.json`
- `captures/raw/20260217T024407Z-i4-t04-io-qt-symbol-r2/io-events.raw.jsonl`
- `captures/raw/20260217T024511Z-i4-t04-io-qt-symbol-r3/manifest.raw.json`
- `captures/raw/20260217T024511Z-i4-t04-io-qt-symbol-r3/io-events.raw.jsonl`
- `captures/redacted/20260216T235428Z-s9p-v3-t05-runner-both-debug-r2/redaction-summary.json`
- `captures/redacted/20260216T235612Z-s9p-v3-t05-runner-both-debug-r3/redaction-summary.json`
- `captures/redacted/20260217T000258Z-s9p-v3-t04f-startup-io-r4/redaction-summary.json`
- `captures/redacted/20260217T010817Z-i3-t04-io-runtime-r5/redaction-summary.json`
- `captures/redacted/20260217T024407Z-i4-t04-io-qt-symbol-r2/redaction-summary.json`
- `captures/redacted/20260217T024511Z-i4-t04-io-qt-symbol-r3/redaction-summary.json`
- `tests/runtime/test_io_hook_script.py`

## S9P Program Kickoff Evidence

- Date: `2026-02-16`
- Gate progress:
  - `G0-PLAN-PUBLISHED`: state/TODO/roadmap artifacts updated for S9P static/runtime tracks; v3 rebase synchronized.
  - `G1-TOOLING-READY`: done for the active debug-specimen instrumentation path.
  - `G2A-STATIC-ARCH-BASELINE`: completed.
  - `G2B-STATIC-FORMAT-BASELINE`: completed (`extract_format_candidates` + canonical format map/report published).
  - `G3A-RUNTIME-CAPTURE-BASELINE`: in progress.
  - `G3B-RUNTIME-FORMAT-BASELINE`: in progress (redacted `io-events` corpus exists; deeper persistence activity still pending).
- Local-only host security ledger for privileged operations:
  - `${HOME}/.nss-security-ledger/changes.md`
  - `${HOME}/.nss-security-ledger/verify.sh`
  - `${HOME}/.nss-security-ledger/rollback.sh`
- Notes:
  - Ledger is intentionally outside git.
  - Baseline snapshots were captured for `DevToolsSecurity`, `system.privilege.taskport`, UI scripting state, and `/dev/bpf*` permissions.
  - `scripts/ghidra_pipeline.sh` completed with app-binary fallback from `/Applications/SoulseekQt.app`.
  - `scripts/extract_search_download_flow.sh` refreshed flow graph and search/download disassembly evidence.
  - Official runner automation is now available through:
    - `tools/runtime/official_runner.py`
    - `scripts/capture_golden.sh` (`OFFICIAL_RUNNER=1`)
  - Persistence format static evidence for v3 is anchored in:
    - `evidence/ui_audit/decomp/nm_demangled_full.txt`
    - `evidence/ui_audit/decomp/mainwindow_methods.txt`
    - `evidence/ui_audit/decomp/transfer_methods.txt`
    - `evidence/ui_audit/ui_strings_feature_candidates.txt`
  - Host unblock application and verification are logged in local ledger entry `CHG-007`.
  - Active runtime capture specimen is `/Users/void/Applications/SoulseekQt-Debug.app`; this preserves the original signed app while enabling Frida instrumentation.
  - I3 runtime hardening:
    - arm64 absolute hook offsets were reconciled from static `nm` evidence,
    - Frida process selection is now disambiguated by path token (`--process-path-contains`) to avoid same-name process ambiguity,
    - `frida_capture` now tolerates expected process-exit teardown (`script is destroyed`) without false failure.
  - I4 runtime compatibility follow-up:
    - Qt symbol-hook candidates now include underscore-prefixed arm64 variants,
    - export lookup now supports both `findExportByName` and `getExportByName` Frida APIs with safe symbol-table fallback,
    - null-address filtering avoids invalid `0x0` hook attempts and preserves deterministic attach.
  - Runtime format traces now include high-signal transfer-store persistence events (`writestring`, `mainwindow_save_data_enter`, `datasaver_save_enter`, `datasaver_save_to_file_enter`) in run `20260217T010817Z-i3-t04-io-runtime-r5`.
  - I4 run `20260217T024511Z-i4-t04-io-qt-symbol-r3` confirms Qt symbol-hook registration and runtime `qfile_open` + `writestring` activity under official-runner flow.
  - Remaining format-runtime gap is concentrated in scenario-level QSettings/QDataStream invocation depth (hooks now resolve/register).

## S9P I5 Download Closure Diagnostics (`2026-02-17`)

- Objective for this iteration: close real-world `search -> options -> download` for music (`Flim`) and collect blocker evidence if not closed.
- Live evidence logs:
  - `tmp/logs/i5-search-flim-20260217105835.log`
  - `tmp/logs/i5-download-patch1-20260217142950.log`
  - `tmp/logs/i5-download-patch2-20260217144007.log`
  - `tmp/logs/i5-download-patch3-pierce-20260217144433.log`
  - `tmp/logs/i5-download-patch4-probe-token-20260217144653.log`
- Implemented/tested protocol changes during I5:
  - transfer fixture drift fix (`peer_transfer_request.hex`, `peer_transfer_response.hex`) + protocol regression guards,
  - control-channel token/offset read-init attempt prior to dedicated F-socket fallback,
  - connect-to-peer response instrumentation and token-aware response matching,
  - modernized peer-init defaults (wire token `0` by default; legacy opt-in via env),
  - optional outbound `PierceFireWall` init frame support for indirect file-socket probing.
- Outcome:
  - search/options path remains healthy (distributed candidates listed with real peer/token/path data),
  - payload completion remains blocked (`bytes_written=0`) under current runtime conditions.
- Runtime signature preserved:
  - `code=40` queue-grant with non-zero file size observed repeatedly,
  - post-grant transfer path collapses into `timed out reading file body chunk`, `peer returned zero bytes`, and `early eof`,
  - queue fallback still hits `code=50 File not shared` / `code=46` path-reject branches.
- Additional blocker evidence:
  - `session.peer-address` indicates at least some target peers advertise obfuscated connectivity (`obfuscation_type=1`, for example `purofu`).
  - Frida attach remains denied in this host context (`PermissionDeniedError`), limiting official in-process runtime tracing for hardwall closure.

## S9A-NEXT Runtime Transfer Diagnostics (In Progress)

- Date: `2026-02-16`
- Environment:
  - Server: `server.slsknet.org:2416`
  - Account: local-only test credential (`fede_test1234`)
  - Queries:
    - `aphex twin flim`
    - fallback: `smells like teen spirit`
- Commands executed:
  - `cargo run -q -p soul-cli -- session search ... --search-mode distributed`
  - `cargo run -q -p soul-cli -- session download-auto ... --search-mode distributed --strict-track flim`
  - multi-candidate diagnostic runs with:
    - `NSS_DEBUG_TRANSFER=1`
    - `NSS_MAX_CANDIDATE_ATTEMPTS=10`
    - `NSS_SKIP_TRANSFER_REQUEST_FLOW=1`
    - `NSS_QUEUE_WAIT_SECS=30`
    - `NSS_TRANSFER_FLOW_TIMEOUT_SECS=60`
    - `NSS_DIRECT_TRANSFER_FLOW_TIMEOUT_SECS=60`
  - username+path queue variant diagnostic:
    - `NSS_QUEUE_UPLOAD_INCLUDE_USERNAME=1`
- Runtime findings:
  - Distributed search consistently resolves many live peers for both `Flim` and popular fallback queries.
  - `PM_TRANSFER_REQUEST`/queue-grant frames are repeatedly observed with non-zero sizes (for example `~12MB`, `~15MB`, `~37MB`, `~84MB`).
  - Even after queue grants, payload transfer still fails (`inbound F timeout`, `peer returned zero bytes for transfer`, `direct flow read frame len / connection reset`).
  - Queue-upload target variants now exercise normalized/suffix paths first and emit explicit peer responses.
  - Most peers reject all queue variants as `File not shared.` (including basename/suffix attempts and username+path attempts).
  - No successful payload transfer yet (`bytes_written > 0` still pending).
- Alternate account/env comparison (`2026-02-16`):
  - Account/env: `.env.local` tuple (`server.slsknet.org:2242`, `nss_auto_*`).
  - Evidence logs:
    - `tmp/logs/altacct-flim-short-20260216040656.log`
    - `tmp/logs/altacct-teen-short-20260216041102.log`
    - `tmp/logs/altacct-flim-outbound-first-20260216043250.log`
    - `tmp/logs/altacct-teen-with-probe-clean-20260216044845.log`
  - Outcome: same hardwall signature reproduced under alternate account/server:
    - queue grants with non-zero sizes,
    - `peer returned zero bytes` and `inbound F timeout`,
    - queue-upload rejection branch (`code=46/50`) with `File not shared`.
- Destination-host account rerun (`2026-02-16`):
  - Account/env: `server.slsknet.org:2416` with `voidfdx`.
  - Evidence log:
    - `tmp/logs/voidfdx-flim-e2e-20260216134739.log`
    - `tmp/logs/voidfdx-flim-short-20260216135537.log`
  - Outcome:
    - distributed candidate discovery remained live (`candidates=31`),
    - queue-deny branch reproduced (`code=50`, `File not shared`) on path variants,
    - queue-grant branch reproduced (`code=40` with non-zero file sizes) followed by transfer failure (`inbound F timeout`, `peer returned zero bytes`, `connection reset`/`early eof`),
    - bounded retry (`NSS_MAX_CANDIDATE_ATTEMPTS=2`) terminated with explicit aggregate failure (`all distributed candidates failed ... queue-upload flow timed out ... direct flow failed`),
    - no successful payload transfer observed.
- Probe path diagnostic (`2026-02-16`):
  - With `SoulseekQt` running concurrently, inbound wait-port bind failed (`Address already in use`) in probe-assisted runs.
  - After terminating `SoulseekQt`, bind conflict disappeared, but transfer still failed with the same queue-grant/zero-byte/denial pattern.
- Official handshake capture attempt (`2026-02-16`):
  - Raw run dirs:
    - `captures/raw/20260216T072154Z-s9a-hardwall-official-search`
    - `captures/raw/20260216T072406Z-s9a-hardwall-official-search-r2`
  - Blockers:
    - Frida attach/helper runtime failure (`frida-helper` launch/permission errors; no `frida-events.raw.jsonl` emitted).
    - Local tcpdump path remains permission-blocked on `/dev/bpf*`.
  - Tooling hardening applied:
    - `tools/runtime/capture_harness.py` now preserves venv interpreter path (no symlink resolve) to avoid launching with wrong Python environment.
  - Destination-host rerun:
    - Raw run dir:
      - `captures/raw/20260216T163830Z-s9a-hardwall-official-smoke`
    - Host adjustments:
      - `DevToolsSecurity -enable` applied (`Developer mode is currently enabled`).
    - Remaining blockers:
      - Frida still cannot attach even to local same-user processes (`PermissionDeniedError unable to access process ... from the current user account`).
      - tcpdump capture still blocked on `/dev/bpf0` permission.
- Baseline official-vs-neo transfer sequence comparison:
  - Source: `captures/redacted/login-search-download/official_frames.hex` and `captures/redacted/login-search-download/neo_frames.hex`
  - Observation: baseline successful run terminates transfer control path at `code=40` then `code=41` with no `code=46/50` denial branch.
  - Current live runs diverge into denial/timeout branches after queue grant.
- Handshake-variant probe (`2026-02-16`):
  - Change: runtime knob `NSS_SEND_CONNECT_TOKEN_ON_PEER_INIT=0` to skip `PM_SEND_CONNECT_TOKEN` on peer-init flows.
  - Evidence:
    - `tmp/logs/altacct-teen-no-connect-token-20260216102133.log`
  - Outcome:
    - transfer still fails with same terminal shape (`queue grant` -> `peer returned zero bytes` and/or `code=46/50 File not shared` + direct-flow EOF).
    - no successful payload transfer observed.
- Outbound file-transfer variant hardening (`2026-02-16`):
  - Code changes:
    - fixed outbound variant loop to reject zero-byte/invalid transfer content and continue probing additional init variants instead of returning early.
    - added queue-upload raw share-prefixed targets (for example `@@share\\...`) and slash variants (`@@share/...`) in target expansion.
    - added outbound init probes:
      - `offset+token` init ordering
      - optional connect-token on outbound file-init (`NSS_SEND_CONNECT_TOKEN_ON_OUTBOUND_FILE_INIT=1`)
      - outbound variant ordering control (`NSS_OUTBOUND_FILE_VARIANT_ORDER`).
  - Regression tests:
    - `cargo test -q -p soul-core outbound_transfer_variants_continue_after_zero_byte_attempt -- --nocapture`
    - `cargo test -q -p soul-core file_transfer_offset_then_token_init_writes_expected_order -- --nocapture`
  - Evidence logs:
    - `tmp/logs/download-teen-e2e-20260216104724.log`
    - `tmp/logs/search-teen-mp3-distributed-20260216112051.log`
    - `tmp/logs/download-teen-mp3-idx12-20260216112224.log`
    - `tmp/logs/download-teen-mp3-idx12-v2-20260216113205.log`
    - `tmp/logs/download-teen-mp3-idx12-finit-20260216114049.log`
    - `tmp/logs/download-teen-mp3-scan-idx0-20260216115000.log`
    - `tmp/logs/download-teen-mp3-scan-idx1-20260216115000.log`
    - `tmp/logs/download-teen-mp3-scan-idx2-20260216115000.log`
    - `tmp/logs/download-teen-mp3-scan-idx3-20260216115000.log`
    - `tmp/logs/download-teen-mp3-scan-idx4-20260216115000.log`
    - `tmp/logs/download-teen-mp3-scan-idx5-20260216115000.log`
  - Outcome:
    - diagnostic coverage improved (full variant traversal visible in logs),
    - queue grants now appear for additional path variants (including raw `@@share` paths),
    - no live payload completion yet (`SCAN_SUCCESS=0`, `bytes_written=0`).
- Frida-free inbound reachability check (`2026-02-16`):
  - Tool: `tools/runtime/check_slsk_porttest.py`
  - Command:
    - `./.venv-tools/bin/python tools/runtime/check_slsk_porttest.py 50036 50037 2242 --json`
  - Result:
    - `50036/tcp CLOSED`
    - `50037/tcp CLOSED`
    - `2242/tcp CLOSED`
  - Interpretation:
    - public inbound connectivity appears blocked in current network environment, consistent with repeated inbound wait-port and inbound F timeout failures.
- Community corroboration scan (Google Groups + Reddit):
  - Reports repeatedly associate "queued/stuck/no transfer" symptoms with:
    - closed/incorrect listen ports or NAT/firewall constraints,
    - VPN/proxy / ISP security filtering,
    - occasional client-version regressions fixed by updates.
  - Sources:
    - `https://groups.google.com/g/soulseek-discussion/c/5FXPNm1pdA0`
    - `https://groups.google.com/g/soulseek-discussion/c/BLIhl7P1cfA`
    - `https://www.reddit.com/r/Soulseek/comments/1ebd1il`
    - `https://www.reddit.com/r/Soulseek/comments/fyosas/new_to_this_my_downloads_getting_stuck_as_queued/`
- Current conclusion:
  - Search-path and candidate discovery are live.
  - Queue/control contracts are now strongly evidenced (grant + denial + timeout branches), but end-to-end transfer remains blocked by runtime hardwall under current public peer/account conditions.
